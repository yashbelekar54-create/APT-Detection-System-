
input {
  beats {
    port => 5044
    type => "sysmon"
  }
}

filter {
  if [agent][type] == "winlogbeat" and [winlog][channel] == "Microsoft-Windows-Sysmon/Operational" {

    # Add event classification based on Sysmon Event ID
    if [winlog][event_id] == 1 {
      mutate { add_field => { "event_category" => "process_creation" } }
    } else if [winlog][event_id] == 3 {
      mutate { add_field => { "event_category" => "network_connection" } }
    } else if [winlog][event_id] == 7 {
      mutate { add_field => { "event_category" => "image_loaded" } }
    } else if [winlog][event_id] == 8 {
      mutate { add_field => { "event_category" => "create_remote_thread" } }
    } else if [winlog][event_id] == 10 {
      mutate { add_field => { "event_category" => "process_access" } }
    } else if [winlog][event_id] == 11 {
      mutate { add_field => { "event_category" => "file_create" } }
    } else if [winlog][event_id] == 12 {
      mutate { add_field => { "event_category" => "registry_event" } }
    } else if [winlog][event_id] == 13 {
      mutate { add_field => { "event_category" => "registry_value_set" } }
    } else if [winlog][event_id] == 22 {
      mutate { add_field => { "event_category" => "dns_query" } }
    }

    # Extract command line arguments for process creation events
    if [winlog][event_id] == 1 {
      grok {
        match => { "[winlog][event_data][CommandLine]" => "(?<command_name>\S+)\s*(?<command_args>.*)" }
        tag_on_failure => ["_grokparsefailure_sysmon_cmdline"]
      }

      # Detect suspicious PowerShell usage
      if [winlog][event_data][Image] =~ /(?i).*powershell.*/ {
        if [winlog][event_data][CommandLine] =~ /(?i).*(bypass|hidden|encodedcommand|noprofile|noninteractive).*/ {
          mutate { 
            add_tag => ["suspicious_powershell"] 
            add_field => { "threat_score" => 7 }
          }
        }
      }

      # Detect potential credential dumping tools
      if [winlog][event_data][Image] =~ /(?i).*(mimikatz|procdump|lsass).*/ or 
         [winlog][event_data][CommandLine] =~ /(?i).*(sekurlsa|lsadump|minidump).*/ {
        mutate { 
          add_tag => ["credential_dumping"] 
          add_field => { "threat_score" => 9 }
        }
      }
    }

    # Process network connection events
    if [winlog][event_id] == 3 {
      # GeoIP enrichment for destination IP
      if [winlog][event_data][DestinationIp] !~ /^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.|127\.)/ {
        geoip {
          source => "[winlog][event_data][DestinationIp]"
          target => "destination_geo"
        }
      }

      # Detect connections to suspicious ports
      if [winlog][event_data][DestinationPort] in ["4444", "8080", "1337", "31337"] {
        mutate { 
          add_tag => ["suspicious_port"] 
          add_field => { "threat_score" => 6 }
        }
      }
    }

    # Process LSASS access events (Event ID 10)
    if [winlog][event_id] == 10 and [winlog][event_data][TargetImage] =~ /(?i).*lsass\.exe/ {
      if [winlog][event_data][GrantedAccess] in ["0x1010", "0x1038", "0x143a"] {
        mutate { 
          add_tag => ["lsass_access"] 
          add_field => { "threat_score" => 8 }
        }
      }
    }

    # MITRE ATT&CK mapping
    if "suspicious_powershell" in [tags] {
      mutate {
        add_field => { "mitre_technique" => "T1059.001" }
        add_field => { "mitre_tactic" => "Execution" }
      }
    }

    if "credential_dumping" in [tags] {
      mutate {
        add_field => { "mitre_technique" => "T1003.001" }
        add_field => { "mitre_tactic" => "Credential Access" }
      }
    }

    if "lsass_access" in [tags] {
      mutate {
        add_field => { "mitre_technique" => "T1003.001" }
        add_field => { "mitre_tactic" => "Credential Access" }
      }
    }

    # Add timestamp
    date {
      match => [ "[winlog][event_data][UtcTime]", "yyyy-MM-dd HH:mm:ss.SSS" ]
      target => "@timestamp"
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "sysmon-logs-%{+YYYY.MM.dd}"
    template_name => "sysmon-template"
    template => "/etc/logstash/templates/sysmon-template.json"
    template_overwrite => true
  }

  # Optional: Send high-threat events to separate index
  if [threat_score] and [threat_score] >= 8 {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "apt-threats-%{+YYYY.MM.dd}"
    }
  }
}
